<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEB GIS SYSTEM</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.2/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css" />
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        /* --- GLOBAL --- */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Sarabun', sans-serif; background: #f0f2f5; overflow: hidden; color: #202124; }
        * { box-sizing: border-box; }

        /* --- DASHBOARD --- */
        #dashboard-view { display: flex; flex-direction: column; height: 100%; width: 100%; z-index: 9999; background: #f0f2f5; position: absolute; top:0; left:0; }
        .dash-header { background: #fff; padding: 15px 30px; border-bottom: 1px solid #dadce0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .dash-logo { font-size: 22px; color: #1a73e8; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .dash-content { padding: 40px; overflow-y: auto; flex: 1; }
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
        .project-card { background: #fff; border-radius: 8px; border: 1px solid #dadce0; cursor: pointer; height: 220px; display: flex; flex-direction: column; position: relative; overflow: hidden; transition: 0.2s; }
        .project-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-color: #1a73e8; }
        .card-preview { flex: 1; background: url('https://mt1.google.com/vt/lyrs=m&x=130&y=95&z=8') center/cover; }
        .card-body { padding: 16px; border-top: 1px solid #dadce0; background: #fff; }
        .card-title { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .card-meta { font-size: 12px; color: #5f6368; }
        .card-delete { position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; color: #d93025; opacity: 0; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .project-card:hover .card-delete { opacity: 1; }
        .btn-create { background: #1a73e8; color: white; padding: 10px 24px; border-radius: 4px; border: none; font-weight: 600; cursor: pointer; }

        /* --- MAP EDITOR --- */
        #map-view { display: none; height: 100%; width: 100%; display: flex; }

        /* LEFT SIDEBAR */
        #sidebar-left { width: 320px; background: #fff; border-right: 1px solid #dadce0; display: flex; flex-direction: column; z-index: 2000; box-shadow: 2px 0 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        .editor-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; }
        .header-top { display: flex; align-items: center; justify-content: space-between; }
        .brand-text { font-size: 18px; font-weight: 700; color: #1a73e8; text-transform: uppercase; }
        .btn-back { cursor: pointer; color: #5f6368; padding: 5px; font-size: 18px; }
        .project-name { border: none; font-size: 16px; font-weight: 600; width: 100%; outline: none; border-bottom: 1px solid transparent; }
        .project-name:focus { border-bottom: 2px solid #1a73e8; }

        .toolbar { padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; gap: 10px; }
        .btn-tool { width: 100%; padding: 8px; background: #fff; border: 1px solid #dadce0; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-tool:hover { background: #e8f0fe; color: #1a73e8; border-color: #1a73e8; }
        
        /* Modern Save Popup CSS */
        .save-modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 12000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .save-modal-box {
            background: white; padding: 30px; border-radius: 16px;
            width: 380px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            font-family: 'Sarabun', sans-serif;
            transform: scale(0.9); opacity: 0; transition: 0.3s;
        }
        .save-modal-box.active { transform: scale(1); opacity: 1; }
        .save-icon { font-size: 50px; color: #1a73e8; margin-bottom: 15px; }
        .save-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; color: #333; }
        .save-input {
            width: 100%; padding: 12px; margin: 15px 0;
            border: 2px solid #eee; border-radius: 8px; font-size: 16px; outline: none; transition: 0.2s;
        }
        .save-input:focus { border-color: #1a73e8; }
        .save-actions { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .btn-save-cancel {
            padding: 10px 20px; border: none; background: #f1f3f4; color: #333;
            border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        .btn-save-confirm {
            padding: 10px 25px; border: none; background: #1a73e8; color: white;
            border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 10px rgba(26,115,232,0.3);
        }
        .btn-save-confirm:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        .search-bar { position: relative; }
        .search-bar input { width: 100%; padding: 8px 35px 8px 10px; border: 1px solid #dadce0; border-radius: 4px; font-family: 'Sarabun'; }
        .search-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #5f6368; cursor: pointer; }

        #layer-list { flex: 1; overflow-y: auto; padding: 0; }
        .layer-group { border-bottom: 1px solid #f0f0f0; }
        .group-header { padding: 10px 15px; display: flex; align-items: center; cursor: pointer; background: #fff; transition:0.2s; position: relative; }
        .group-header:hover { background: #f9f9f9; }
        .group-header.active-target { border-left: 4px solid #1a73e8; background: #f0f5ff; }
        
        .group-toggle-icon { width: 20px; text-align: center; color: #5f6368; margin-right: 5px; font-size: 12px; }
        .group-title { font-weight: 600; font-size: 13px; flex: 1; margin-left: 8px; }
        .group-actions { display: none; margin-left: auto; }
        .group-header:hover .group-actions { display: block; }
        .menu-dots { color: #5f6368; padding: 4px 8px; border-radius: 4px; font-size: 14px; }
        .menu-dots:hover { background: #e0e0e0; color: #1a73e8; }

        /* Dropdown Menu */
        .dropdown-menu { display: none; position: absolute; right: 10px; top: 35px; background: #fff; border: 1px solid #dadce0; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); z-index: 100; min-width: 160px; }
        .dropdown-item { padding: 10px 15px; font-size: 13px; color: #3c4043; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .dropdown-item:hover { background: #f1f3f4; color: #1a73e8; }
        .dropdown-item.delete { color: #d93025; border-top: 1px solid #eee; }

        .sub-items { display: block; padding-left: 0; }
        .layer-item { padding: 6px 15px 6px 45px; display: flex; align-items: center; cursor: pointer; font-size: 13px; border-left: 3px solid transparent; }
        .layer-item:hover { background: #e8f0fe; border-left-color: #1a73e8; }

        /* CENTER MAP */
        #map { flex: 1; height: 100%; background: #e5e3df; z-index: 1; }

        /* RIGHT SIDEBAR */
        #sidebar-right { width: 400px; background: #fff; border-left: 1px solid #dadce0; display: flex; flex-direction: column; z-index: 2000; box-shadow: -2px 0 5px rgba(0,0,0,0.1); flex-shrink: 0; transition: width 0.3s; }
        #sidebar-right.expanded { width: 650px; }
        .rs-header { padding: 12px 20px; font-weight: 600; border-bottom: 1px solid #dadce0; display: flex; justify-content: space-between; align-items: center; background: #fff; height: 50px; flex-shrink: 0; }
        #sv-container { height: 350px; background: #202124; position: relative; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        #sv-image, #sv-iframe { width: 100%; height: 100%; object-fit: cover; border: none; }
        #sv-msg { color: #aaa; font-size: 13px; }
        #info-container { flex: 1; padding: 20px; overflow-y: auto; background: #fff; border-top: 1px solid #eee; }
        .info-row { border-bottom: 1px solid #f1f3f4; padding: 10px 0; display: flex; justify-content: space-between; }
        .label { font-size: 12px; font-weight: 600; color: #5f6368; margin-right: 10px; flex-shrink: 0; }
        .value { font-size: 14px; color: #202124; text-align: right; word-break: break-word; }

        /* POPUP (Modern + Resized) */
        .leaflet-popup-content-wrapper { padding: 0; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: none; }
        .leaflet-popup-content { margin: 0; min-width: 360px !important; font-family: 'Sarabun'; }
        .leaflet-popup-tip { box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .popup-header { padding: 15px 20px 5px; border-bottom: 1px solid #f0f0f0; }
        .popup-title-inp { width: 100%; border: none; font-size: 16px; font-weight: 600; color: #202124; outline: none; background: transparent; }
        .popup-body { padding: 15px 20px; }
        .popup-desc-inp { width: 100%; border: none; resize: none; font-size: 13px; outline: none; font-family: 'Sarabun'; color: #5f6368; background: transparent; min-height: 40px; }
        .color-picker-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .color-circle { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .color-circle:hover { transform: scale(1.1); }
        .popup-footer { border-top: 1px solid #f0f0f0; padding: 10px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fafafa; border-radius: 0 0 8px 8px; }
        .pop-icon { cursor: pointer; color: #5f6368; font-size: 14px; padding: 6px; border-radius: 4px; transition: 0.2s; }
        .pop-icon:hover { background: #f0f0f0; color: #1a73e8; }
        .pop-icon.del:hover { background: #fce8e6; color: #d93025; }

        /* MODALS (General) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 400px; max-width: 90%; border-radius: 8px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        /* Table Modal */
        .table-modal-box { width: 95%; max-width: 1400px; height: 90%; display: flex; flex-direction: column; }
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
        .data-table th { background-color: #f8f9fa; position: sticky; top: 0; font-weight: 600; border-bottom: 2px solid #ddd; padding: 10px; border-right: 1px solid #eee; white-space: nowrap; z-index: 10; }
        .data-table td { border-bottom: 1px solid #eee; padding: 8px 10px; border-right: 1px solid #eee; white-space: nowrap; min-width: 100px; position: relative; }
        .data-table td[contenteditable="true"] { background: #fff; cursor: text; }
        .data-table td[contenteditable="true"]:focus { background: #e8f0fe; outline: 2px solid #1a73e8; z-index: 5; }
        
        .col-del-btn { color: #999; cursor: pointer; margin-left: 5px; font-size: 12px; float: right; }
        .col-del-btn:hover { color: #d93025; }
        .row-del-btn { color: #d93025; cursor: pointer; text-align: center; }
        .row-del-btn:hover { color: #b0281f; }

        /* Controls */
        .leaflet-control-locate { background: white; width: 34px; height: 34px; border-radius: 4px; display: flex; justify-content: center; align-items: center; cursor: pointer; margin-top: 10px !important; box-shadow: 0 1px 5px rgba(0,0,0,0.4); }
        .google-marker-icon { filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3)); }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:11000; display:none; justify-content:center; align-items:center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-title" style="font-size:18px; font-weight:600; margin-bottom:10px; color:#1a73e8;"></div>
            <div id="modal-desc" style="font-size:14px; color:#555; margin-bottom:20px;"></div>
            <input type="text" id="modal-input" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; display:none;">
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button onclick="closeModal()" style="padding:8px 20px; background:#fff; border:1px solid #ddd; border-radius:4px; cursor:pointer;">ยกเลิก</button>
                <button id="modal-confirm-btn" style="padding:8px 20px; background:#1a73e8; color:white; border:none; border-radius:4px; cursor:pointer;">ยืนยัน</button>
            </div>
        </div>
    </div>

    <div id="export-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" style="font-size:18px; font-weight:600; margin-bottom:15px;">ส่งออกข้อมูล</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn-tool" onclick="triggerExport('shapefile')"><i class="fa-solid fa-file-zipper"></i> Shapefile (.zip)</button>
                <button class="btn-tool" onclick="triggerExport('geojson')"><i class="fa-solid fa-code"></i> GeoJSON</button>
                <button class="btn-tool" onclick="triggerExport('kml')"><i class="fa-solid fa-earth-americas"></i> KML</button>
                <button class="btn-tool" onclick="triggerExport('csv')"><i class="fa-solid fa-table"></i> CSV</button>
            </div>
            <button onclick="document.getElementById('export-modal').style.display='none'" style="width:100%; margin-top:20px; padding:10px; background:#eee; border:none; cursor:pointer;">ปิด</button>
        </div>
    </div>

    <div id="table-modal" class="modal-overlay">
        <div class="modal-box table-modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <span style="font-size:18px; font-weight:600;">ตารางข้อมูลรายชื่อ</span>
                <div>
                    <button onclick="addNewColumn()" style="padding:8px 15px; background:#fff; border:1px solid #ddd; border-radius:4px; margin-right:5px; cursor:pointer;">+ เพิ่มคอลัมน์</button>
                    <button onclick="addTableRow()" style="padding:8px 15px; background:#fff; border:1px solid #ddd; border-radius:4px; margin-right:5px; cursor:pointer;">+ เพิ่มแถว</button>
                    <button onclick="saveTableChanges()" style="padding:8px 20px; background:#1a73e8; color:white; border:none; border-radius:4px; margin-right:10px; cursor:pointer; font-weight:600;">บันทึก</button>
                    <button onclick="document.getElementById('table-modal').style.display='none'" style="background:none; border:none; font-size:24px; cursor:pointer;">×</button>
                </div>
            </div>
            <div id="table-content" style="flex:1; overflow:auto; border:1px solid #eee;"></div>
        </div>
    </div>

    <div id="saveModal" class="save-modal-overlay">
        <div class="save-modal-box" id="saveModalBox">
            <div id="saveIconContainer" class="save-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
            <div id="saveTitle" class="save-title">บันทึกโปรเจกต์</div>
            <input type="text" id="projectNameInput" class="save-input" placeholder="ตั้งชื่อผลงานของคุณ...">
            <div class="save-actions" id="saveActions">
                <button class="btn-save-cancel" onclick="closeSaveModal()">ยกเลิก</button>
                <button class="btn-save-confirm" id="btnConfirmSave" onclick="confirmSaveToSupabase()">บันทึกทันที</button>
            </div>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div><div style="margin-top:10px; color:#1a73e8; font-weight:600;">กำลังดำเนินการ...</div></div>

    <div id="dashboard-view">
        <div class="dash-header">
            <div class="dash-logo"><i class="fa-solid fa-earth-americas"></i> WEB GIS SYSTEM</div>
            <button class="btn-create" onclick="createNewProject()">+ สร้างแผนที่ใหม่</button>
        </div>
        <div class="dash-content">
            <div class="project-grid" id="project-grid"></div>
        </div>
    </div>

    <div id="map-view">
        <div id="sidebar-left">
            <div class="editor-header">
                <div class="header-top">
                    <div class="brand-text"><i class="fa-solid fa-earth-americas"></i> WEB GIS SYSTEM</div>
                    <div class="btn-back" onclick="saveAndExit()"><i class="fa-solid fa-arrow-left"></i></div>
                </div>
                <input type="text" id="proj-name" class="project-name" value="แผนที่ไม่มีชื่อ" onchange="updateMetaName(this.value)">
            </div>

            <div class="toolbar">
                <div class="btn-tool" onclick="saveProject()" style="background-color: #28a745; color: white; margin-bottom: 5px;">
                    <i class="fa-solid fa-save"></i> บันทึกงาน
                </div>
                <div class="btn-tool" onclick="document.getElementById('fileInput').click()">
                    <i class="fa-solid fa-upload"></i> นำเข้าข้อมูล (Zip/KML/JSON)
                </div>
                <input type="file" id="fileInput" accept=".zip,.kml,.json,.geojson,.csv" style="display:none;">
                <input type="file" id="layerFileInput" accept=".zip,.kml,.json,.geojson,.csv" style="display:none;">
                
                <div class="search-bar">
                    <input type="text" id="search-inp" placeholder="ค้นหาสถานที่ (กด Enter)...">
                    <div class="search-btn" onclick="searchLoc()"><i class="fa-solid fa-magnifying-glass"></i></div>
                </div>

                <button style="width:100%; padding:10px; background:#fff; border:1px dashed #1a73e8; border-radius:4px; color:#1a73e8; cursor:pointer; margin-top:5px;" onclick="showInputModal('เพิ่มเลเยอร์', 'ชื่อเลเยอร์:', (name)=>createGroupUI(name))">
                    <i class="fa-solid fa-layer-group"></i> เพิ่มเลเยอร์ใหม่
                </button>
            </div>

            <div id="layer-list"></div>
        </div>

        <div id="map"></div>

        <div id="sidebar-right">
            <div class="rs-header">
                <span><i class="fa-solid fa-street-view"></i> มุมมองถนน</span>
                <button onclick="toggleSize()" style="background:none; border:1px solid #ccc; border-radius:4px; cursor:pointer;"><i class="fa-solid fa-expand"></i></button>
            </div>
            <div id="sv-container">
                <div id="sv-msg" style="color:#aaa;">คลิกจุดบนแผนที่</div>
                <img id="sv-image" style="display:none;">
                <iframe id="sv-iframe" style="display:none;"></iframe>
            </div>
            <div class="rs-header" style="border-top:1px solid #eee; background:#f8f9fa;">รายละเอียดสถานที่</div>
            <div id="info-container">
                <div style="text-align:center; padding-top:20px; color:#999;">เลือกสถานที่เพื่อดูข้อมูล</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.14.2/dist/leaflet-geoman.min.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <script src="https://unpkg.com/tokml@0.4.0/tokml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/shp-write@0.3.2/shpwrite.js"></script>

    <script>
        // --- Global Variables ---
        let map, currentProjId, layerStore = {}, clickMarker, exportTargetGroupId;
        let selectedSubId = null;
        let editingLayerId = null; 
        let currentTableGroup = null;

        const googleRedIcon = L.icon({
            iconUrl: 'https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2.png',
            iconSize: [27, 43], iconAnchor: [13, 43], popupAnchor: [0, -40], className: 'google-marker-icon'
        });

        // --- 1. DASHBOARD ---
        function initDashboard() {
            document.getElementById('dashboard-view').style.display='flex';
            document.getElementById('map-view').style.display='none';
            renderProjects();
        }
        function getMeta() { 
            try {
                const data = localStorage.getItem('webgis_meta');
                return data ? JSON.parse(data) : [];
            } catch(e) { return []; }
        }
        function renderProjects() {
            const grid = document.getElementById('project-grid'); grid.innerHTML = '';
            const meta = getMeta();
            if (Array.isArray(meta)) {
                meta.reverse().forEach(p => {
                    const card = document.createElement('div'); card.className = 'project-card';
                    let bg = 'https://mt1.google.com/vt/lyrs=m&x=130&y=95&z=8'; 
                    card.innerHTML = `<div class="card-delete" onclick="askDeleteProject('${p.id}', event)"><i class="fa-solid fa-trash"></i></div><div class="card-preview" style="background-image:url('${bg}')"></div><div class="card-body"><div class="card-title">${p.name}</div><div class="card-meta">${new Date(p.date).toLocaleDateString('th-TH')}</div></div>`;
                    card.onclick = () => openProject(p.id);
                    grid.appendChild(card);
                });
            }
        }
        function createNewProject() {
            try {
                const id = 'proj_' + Date.now();
                const meta = getMeta();
                meta.push({ id: id, name: "แผนที่ไม่มีชื่อ", date: Date.now() });
                localStorage.setItem('webgis_meta', JSON.stringify(meta));
                localStorage.setItem('webgis_data_' + id, JSON.stringify([]));
                openProject(id);
            } catch(e) { alert("เกิดข้อผิดพลาดในการสร้างโปรเจค: " + e); }
        }
        function askDeleteProject(id, e) {
            e.stopPropagation();
            showModal("ลบแผนที่", "ยืนยันการลบ?", true, () => {
                let meta = getMeta().filter(p => p.id !== id);
                localStorage.setItem('webgis_meta', JSON.stringify(meta));
                localStorage.removeItem('webgis_data_' + id);
                renderProjects();
            });
        }

        // --- 2. MAP CORE ---
        function initMap() {
            if(map) return;
            map = L.map('map', { zoomControl: false }).setView([13.7563, 100.5018], 11);
            L.control.zoom({ position: 'topleft' }).addTo(map);

            const btn = L.DomUtil.create('div', 'leaflet-control-locate leaflet-bar');
            btn.innerHTML = '<i class="fa-solid fa-crosshairs"></i>';
            btn.onclick = () => map.locate({setView:true, maxZoom:16});
            const Ctl = L.Control.extend({ options:{position:'topleft'}, onAdd:()=>btn });
            map.addControl(new Ctl());
            map.on('locationfound', e => { handleMapClick(e.latlng, "ตำแหน่งของคุณ"); });

            // Base Layers
            const gStreet = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);
            const gHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']});
            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
            const esri = L.esri.basemapLayer('Imagery');
            
            L.control.layers({ 
                "Google ถนน": gStreet, "Google ดาวเทียม": gHybrid, "OpenStreetMap": osm, "Esri Imagery": esri
            }, null, { position: 'bottomright' }).addTo(map);

            map.pm.addControls({ position: 'topleft', drawCircle:true, drawCircleMarker:false });
            L.control.polylineMeasure({ position: 'topleft', unit: 'metric' }).addTo(map);

            map.on('pm:create', e => handleDraw(e.layer));
            map.on('pm:remove', e => handleDelete(e.layer));
            map.on('pm:edit', saveData); map.on('pm:dragend', saveData);
            map.on('click', e => { if(!map.pm.globalRemovalModeEnabled()) handleMapClick(e.latlng); });
        }

        function openProject(id) {
            showLoader(true); currentProjId = id; initMap();
            Object.values(layerStore).forEach(l => map.removeLayer(l)); layerStore = {};
            if(clickMarker) map.removeLayer(clickMarker);
            document.getElementById('layer-list').innerHTML = '';
            selectedSubId = null;
            
            const meta = getMeta().find(p => p.id === id);
            document.getElementById('proj-name').value = meta.name;

            setTimeout(() => {
                const data = JSON.parse(localStorage.getItem('webgis_data_' + id) || '[]');
                if(data.length) {
                    const groups = {};
                    data.forEach(f => {
                        const g = f.properties._layerName || "นำเข้า";
                        if(!groups[g]) groups[g] = []; groups[g].push(f);
                    });
                    for(let g in groups) {
                        const subId = createGroupUI(g);
                        L.geoJSON(groups[g], { 
                            onEachFeature: (f,l) => setupLayer(l, subId, f.properties),
                            pointToLayer: function (feature, latlng) {
                                return createCustomMarker(latlng, feature.properties._color || '#1a73e8');
                            },
                            style: (f) => ({ color: f.properties._color || '#3388ff', fillColor: f.properties._color || '#3388ff' })
                        });
                    }
                    const grp = L.featureGroup(Object.values(layerStore));
                    if(grp.getLayers().length) map.fitBounds(grp.getBounds());
                } else createGroupUI("เลเยอร์ 1");
                
                document.getElementById('dashboard-view').style.display = 'none';
                document.getElementById('map-view').style.display = 'flex';
                map.invalidateSize(); showLoader(false);
            }, 500);
        }

        function saveAndExit() { saveData(); initDashboard(); }
        function saveData() {
            if(!currentProjId) return;
            const geojson = [];
            document.querySelectorAll('.layer-group').forEach(gDiv => {
                const gName = gDiv.querySelector('.group-title').innerText;
                gDiv.querySelectorAll('.layer-item').forEach(item => {
                    const layer = layerStore[item.id.replace('row-', '')];
                    if(layer) {
                        const j = layer.toGeoJSON();
                        j.properties = layer.feature.properties;
                        j.properties._layerName = gName;
                        geojson.push(j);
                    }
                });
            });
            localStorage.setItem('webgis_data_' + currentProjId, JSON.stringify(geojson));
            let meta = getMeta(); 
            let p = meta.find(p=>p.id===currentProjId);
            if(p) {
                p.name = document.getElementById('proj-name').value;
                localStorage.setItem('webgis_meta', JSON.stringify(meta));
            }
        }

        // --- 3. LAYERS ---
        function createGroupUI(name) {
            const id = 'g-' + Date.now() + Math.random().toString(16).slice(2);
            const subId = 'sub-' + id;
            const div = document.createElement('div'); div.className = 'layer-group'; div.id = id;
            div.innerHTML = `
                <div class="group-header active-target" onclick="selectLayerGroup('${subId}', this)">
                    <div class="group-toggle-icon" onclick="event.stopPropagation(); toggleSubItems('${subId}', this)">▼</div>
                    <input type="checkbox" checked onclick="event.stopPropagation(); toggleAll('${subId}', this.checked)" style="margin-right:10px; cursor:pointer;">
                    <span class="group-title">${name}</span>
                    <div class="group-actions">
                         <div class="menu-dots" onclick="event.stopPropagation(); toggleMenu('${id}-menu')"><i class="fa-solid fa-ellipsis-vertical"></i></div>
                    </div>
                    <div id="${id}-menu" class="dropdown-menu">
                        <div class="dropdown-item" onclick="importToLayer('${subId}', '${id}-menu')"><i class="fa-solid fa-upload"></i> นำเข้าข้อมูล</div>
                        <div class="dropdown-item" onclick="openTable('${name}', '${id}-menu', '${subId}')"><i class="fa-solid fa-table"></i> ดูตารางข้อมูล</div>
                        <div class="dropdown-item" onclick="exportGroup('${name}', '${id}-menu')"><i class="fa-solid fa-download"></i> ส่งออกเลเยอร์</div>
                        <div class="dropdown-item delete" onclick="askDeleteGroup('${id}', '${id}-menu')"><i class="fa-solid fa-trash"></i> ลบเลเยอร์</div>
                    </div>
                </div>
                <div class="sub-items" id="${subId}"></div>`;
            document.getElementById('layer-list').appendChild(div);
            selectLayerGroup(subId, div.querySelector('.group-header'));
            return subId;
        }

        function toggleSubItems(subId, iconEl) {
            const sub = document.getElementById(subId);
            if (sub.style.display === 'none') {
                sub.style.display = 'block';
                iconEl.innerText = '▼';
            } else {
                sub.style.display = 'none';
                iconEl.innerText = '▶';
            }
        }

        function toggleMenu(menuId) {
            const menu = document.getElementById(menuId);
            const isVisible = menu.style.display === 'block';
            document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
            if (!isVisible) menu.style.display = 'block';
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.group-header')) {
                document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
            }
        });

        function selectLayerGroup(subId, headerElement) {
            document.querySelectorAll('.group-header').forEach(el => el.classList.remove('active-target'));
            headerElement.classList.add('active-target');
            selectedSubId = subId;
        }

        function toggleAll(subId, checked) {
            document.getElementById(subId).querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = checked;
                cb.dispatchEvent(new Event('change'));
            });
        }

        function createCustomMarker(latlng, color) {
            const svgIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="36" height="36" fill="${color}" stroke="#ffffff" stroke-width="1.5"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`,
                iconSize: [36, 36], iconAnchor: [18, 36], popupAnchor: [0, -36]
            });
            return L.marker(latlng, { icon: svgIcon });
        }

        function setupLayer(layer, subId, props) {
            if (layer instanceof L.Marker) {
               const latlng = layer.getLatLng();
               const color = props._color || '#1a73e8';
               if (!(layer.options.icon && layer.options.icon.options.className === 'custom-div-icon')) {
                   layer = createCustomMarker(latlng, color);
               }
            }
            
            layer.addTo(map);
            const lid = L.stamp(layer);
            layerStore[lid] = layer;
            layer.subId = subId;
            layer.feature = layer.feature || { type: "Feature", properties: props || {} };
            
            if(layer.bindTooltip) {
                layer.bindTooltip(props.name || "ไม่มีชื่อ", { direction: 'top', offset: [0,-36] });
            }
            if(layer instanceof L.Path && props._color) {
                layer.setStyle({ color: props._color, fillColor: props._color });
            }

            const name = getSmartName(layer.feature.properties);
            const div = document.createElement('div'); div.className = 'layer-item'; div.id = 'row-' + lid;
            div.innerHTML = `<input type="checkbox" checked onchange="toggleLayer(${lid}, this.checked)"><span id="lbl-${lid}">${getIcon(layer)} ${name}</span>`;
            div.onclick = (e) => { if(e.target.type!=='checkbox'){ panTo(layer); showInfo(layer.feature.properties, getCenter(layer)); layer.openPopup(); }};
            document.getElementById(subId).appendChild(div);

            layer.bindPopup(createPopup(layer, name));
            layer.on('click', e => { if(!map.pm.globalRemovalModeEnabled()){ L.DomEvent.stopPropagation(e); showInfo(layer.feature.properties, e.latlng || getCenter(layer)); }});
        }

        window.toggleLayer = function(lid, checked) {
            if (checked) map.addLayer(layerStore[lid]); else map.removeLayer(layerStore[lid]);
        };

        function handleDraw(layer) {
            let subId = selectedSubId || (document.querySelectorAll('.sub-items').length ? document.querySelectorAll('.sub-items')[0].id : createGroupUI("เลเยอร์ 1"));
            if (layer instanceof L.Marker) {
                const latlng = layer.getLatLng();
                map.removeLayer(layer);
                layer = createCustomMarker(latlng, '#1a73e8');
                layer.addTo(map);
            }
            setupLayer(layer, subId, { name: "จุดใหม่", description: "" });
            saveData(); setTimeout(()=> {layer.openPopup(); enableEdit(L.stamp(layer));}, 200);
        }
        function handleDelete(layer) {
            const row = document.getElementById('row-' + L.stamp(layer));
            if(row) row.remove(); delete layerStore[L.stamp(layer)]; saveData();
        }

        // --- 4. SMART PLACE NAMES & SEARCH ---
        function handleMapClick(latlng, manualName) {
            if(clickMarker) map.removeLayer(clickMarker);
            clickMarker = createCustomMarker(latlng, '#d93025');
            clickMarker.addTo(map);
            map.panTo(latlng);

            if(manualName) {
                clickMarker.bindPopup(createSimplePopup(manualName, manualName, latlng)).openPopup();
                showInfo({"ที่อยู่": manualName}, latlng);
                return;
            }

            fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latlng.lat}&lon=${latlng.lon}&accept-language=th&addressdetails=1&zoom=18`)
            .then(r=>r.json()).then(d=>{
                let name = "ตำแหน่งที่เลือก", detail = d.display_name || "";
                if (d.name && d.name.length > 0) name = d.name; 
                else if(d.address) {
                    const a = d.address;
                    name = a.amenity || a.shop || a.tourism || a.building || a.office || a.leisure || a.natural;
                    if(!name) name = a.road ? (a.soi ? a.road + " " + a.soi : a.road) : (a.village || a.suburb);
                }
                if(!name || name === "undefined") name = detail.split(',')[0];
                clickMarker.bindPopup(createSimplePopup(name, detail, latlng)).openPopup();
                showInfo({"สถานที่": name, "ที่อยู่": detail}, latlng);
            }).catch(() => {});
        }

        function searchLoc() {
            const q = document.getElementById('search-inp').value;
            if(!q) return; showLoader(true);
            fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${q}&accept-language=th&addressdetails=1`)
            .then(r=>r.json()).then(d=>{
                showLoader(false);
                if(d.length) {
                    const lat=parseFloat(d[0].lat), lon=parseFloat(d[0].lon);
                    map.setView([lat,lon], 16);
                    handleMapClick({lat:lat, lon:lon}, d[0].display_name.split(',')[0]);
                } else showModal("ไม่พบ","ไม่พบสถานที่",false,()=>{});
            }).catch(()=>{showLoader(false)});
        }
        document.getElementById('search-inp').addEventListener('keypress', function (e) { if (e.key === 'Enter') searchLoc(); });

        // --- 5. IMPORT/EXPORT ---
        function processFile(file, subId) {
            if(!file) return; showLoader(true);
            const fileName = file.name;
            const ext = fileName.split('.').pop().toLowerCase();
            const targetId = subId || createGroupUI(fileName.replace(/\.[^/.]+$/, ""));

            if (ext === 'zip') {
                const r = new FileReader(); 
                r.onload = function(b) { 
                    shp(b.target.result).then(function(geojson){
                        if(Array.isArray(geojson)) { geojson.forEach(g => finishImport(g, targetId)); } 
                        else { finishImport(geojson, targetId); }
                    }).catch(err => { alert("Zip Error"); showLoader(false); });
                }
                r.readAsArrayBuffer(file);
            } 
            else if (['kml', 'json', 'geojson'].includes(ext)) {
                const r = new FileReader(); r.onload=t=>{ 
                    try { 
                        let g = file.name.endsWith('.kml') ? toGeoJSON.kml(new DOMParser().parseFromString(t.target.result,'text/xml')) : JSON.parse(t.target.result);
                        finishImport(g, targetId);
                    } catch(e){ alert("File Error: " + e); showLoader(false); }
                }; r.readAsText(file);
            } 
            document.getElementById('fileInput').value = ''; document.getElementById('layerFileInput').value = '';
        }
        document.getElementById('fileInput').onchange = function(e) { processFile(e.target.files[0], null); };
        document.getElementById('layerFileInput').onchange = function(e) { processFile(e.target.files[0], selectedSubId); };

        function importToLayer(subId, menuId) {
            selectedSubId = subId;
            document.getElementById(menuId).style.display = 'none'; 
            document.getElementById('layerFileInput').click();
        }
        function finishImport(g, subId) {
            const grp = L.featureGroup();
            const features = Array.isArray(g) ? g : (g.features || [g]); 
            L.geoJSON(features, { 
                pointToLayer: function (feature, latlng) { return createCustomMarker(latlng, '#1a73e8'); },
                onEachFeature:(f,l)=>{
                    f.properties._layerName = document.getElementById(subId).previousElementSibling.querySelector('.group-title').innerText;
                    setupLayer(l,subId,f.properties); 
                    grp.addLayer(l);
                }
            });
            if(grp.getLayers().length) map.fitBounds(grp.getBounds());
            saveData(); showLoader(false);
        }
        function exportGroup(groupName, menuId) { 
            if(menuId) document.getElementById(menuId).style.display = 'none';
            exportTargetGroupId = groupName; document.getElementById('export-modal').style.display='flex'; 
        }
        function triggerExport(format) {
            let data = [];
            Object.values(layerStore).forEach(l => {
                if(l.feature.properties._layerName === exportTargetGroupId) {
                    let f = l.toGeoJSON(); f.properties = l.feature.properties; data.push(f);
                }
            });
            if(!data.length) return alert("ไม่มีข้อมูล");
            const name = exportTargetGroupId || "data";
            const geojson = {type:'FeatureCollection', features:data};
            let content, ext, type;

            if(format === 'shapefile') {
                try {
                    const options = { folder: name, types: { point: name+'_pt', polygon: name+'_poly', line: name+'_line' } };
                    shpwrite.download(geojson, options); document.getElementById('export-modal').style.display='none'; return; 
                } catch(e) { return alert("Export Error"); }
            } else if(format === 'csv') {
                const rows = data.map(f => {
                    let r = { ...f.properties };
                    if(f.geometry.type === 'Point') { r.lat = f.geometry.coordinates[1]; r.lng = f.geometry.coordinates[0]; }
                    return r;
                });
                content = Papa.unparse(rows); ext = 'csv'; type = 'text/csv;charset=utf-8;';
            } else if(format === 'kml') {
                content = tokml(geojson); ext = 'kml'; type = 'application/vnd.google-earth.kml+xml;charset=utf-8';
            } else {
                content = JSON.stringify(geojson); ext = 'geojson'; type = 'application/json;charset=utf-8';
            }
            const blob = new Blob(["\uFEFF"+content], {type:type});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name+'.'+ext; a.click();
            document.getElementById('export-modal').style.display='none';
        }

        // --- 6. POPUP ---
        function createPopup(layer, name) {
            const lid = L.stamp(layer);
            const desc = layer.feature.properties.description || "";
            return `
                <div class="popup-header"><input class="popup-title-inp" id="pt-${lid}" value="${name}" readonly></div>
                <div class="popup-body">
                    <textarea class="popup-desc-inp" id="pd-${lid}" readonly placeholder="เพิ่มคำอธิบาย...">${desc}</textarea>
                    <div class="color-picker-row" id="cp-${lid}" style="display:none;">
                        <div class="color-circle" style="background:#1a73e8" onclick="changeColor(${lid}, '#1a73e8')"></div>
                        <div class="color-circle" style="background:#d93025" onclick="changeColor(${lid}, '#d93025')"></div>
                        <div class="color-circle" style="background:#f9ab00" onclick="changeColor(${lid}, '#f9ab00')"></div>
                        <div class="color-circle" style="background:#1e8e3e" onclick="changeColor(${lid}, '#1e8e3e')"></div>
                        <input type="color" onchange="changeColor(${lid}, this.value)" style="width:30px; border:none; background:none; cursor:pointer;">
                    </div>
                </div>
                <div class="popup-footer">
                    <i class="fa-solid fa-pen pop-icon" title="แก้ไข" onclick="enableEdit(${lid})"></i>
                    <i class="fa-solid fa-trash pop-icon del" title="ลบ" onclick="deleteFeature(${lid})"></i>
                    <i class="fa-solid fa-check pop-icon" id="ps-${lid}" style="display:none; color:#1e8e3e" onclick="saveEdit(${lid})"></i>
                </div>`;
        }
        function enableEdit(lid) { 
            document.getElementById(`pt-${lid}`).removeAttribute('readonly'); document.getElementById(`pt-${lid}`).focus(); 
            document.getElementById(`pd-${lid}`).removeAttribute('readonly'); 
            document.getElementById(`ps-${lid}`).style.display='inline'; document.getElementById(`cp-${lid}`).style.display='flex'; 
        }
        function changeColor(lid, c) { 
            const l = layerStore[lid]; 
            if(l instanceof L.Marker && l.options.icon.options.className === 'custom-div-icon') {
                l.setIcon(createCustomMarker(l.getLatLng(), c).options.icon);
            } else if(l.setStyle) { l.setStyle({color:c, fillColor:c}); }
            l.feature.properties._color = c; 
        }
        function saveEdit(lid) { 
            const l = layerStore[lid], n = document.getElementById(`pt-${lid}`).value; 
            l.feature.properties.name = n; l.feature.properties.description = document.getElementById(`pd-${lid}`).value; 
            document.getElementById(`lbl-${lid}`).innerHTML = `${getIcon(l)} ${n}`; 
            l.closePopup(); l.unbindPopup(); l.bindPopup(createPopup(l, n)); l.openPopup(); saveData(); 
        }
        function deleteFeature(lid) {
            showModal("ลบข้อมูล", "ยืนยันการลบ?", true, () => {
                const layer = layerStore[lid]; map.removeLayer(layer);
                const row = document.getElementById('row-' + lid); if(row) row.remove();
                delete layerStore[lid]; saveData(); closeModal();
            });
        }
        function createSimplePopup(t,d,l) { return `<div style="padding:5px;"><div style="font-weight:600;font-size:16px;">${t}</div><div style="font-size:12px;color:#666;margin:5px 0;line-height:1.4;">${d}</div><div style="color:#1a73e8;font-size:12px;">${l.lat.toFixed(5)}, ${l.lng.toFixed(5)}</div></div>`; }

        // --- 7. TABLE ---
        function openTable(targetGroup, menuId, subId) {
            if(menuId) document.getElementById(menuId).style.display = 'none';
            currentTableGroup = targetGroup; currentTableSubId = subId; 
            let headers = new Set(['name', 'description']), tableData = [];
            Object.values(layerStore).forEach(l => {
                if(l.feature.properties._layerName === targetGroup) {
                    Object.keys(l.feature.properties).forEach(k => { if(!k.startsWith('_')) headers.add(k); });
                    tableData.push({ id: L.stamp(l), props: l.feature.properties });
                }
            });
            let html = `<table class="data-table"><thead><tr>`;
            headers.forEach(h => html += `<th>${h} <i class="fa-solid fa-times col-del-btn" onclick="deleteColumn('${h}')"></i></th>`);
            html += `<th>จัดการ</th></tr></thead><tbody>`;
            tableData.forEach(row => {
                html += `<tr>`;
                headers.forEach(h => html += `<td contenteditable="true" onblur="updateCell(${row.id}, '${h}', this.innerText)">${row.props[h] || ''}</td>`);
                html += `<td><i class="fa-solid fa-trash row-del-btn" onclick="deleteTableRow(${row.id})"></i></td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('table-content').innerHTML = html; document.getElementById('table-modal').style.display = 'flex';
        }
        function updateCell(lid, key, value) {
            if(layerStore[lid]) { layerStore[lid].feature.properties[key] = value; saveData(); }
        }
        function addNewColumn() {
            showInputModal("เพิ่มคอลัมน์ใหม่", "ชื่อ:", (colName) => {
                Object.values(layerStore).forEach(l => { if(l.feature.properties._layerName === currentTableGroup) l.feature.properties[colName] = ""; });
                saveData(); openTable(currentTableGroup, null, currentTableSubId);
            });
        }
        function deleteColumn(colName) {
            showModal("ลบคอลัมน์", `ยืนยันลบ "${colName}"?`, true, () => {
                Object.values(layerStore).forEach(l => { if(l.feature.properties._layerName === currentTableGroup) delete l.feature.properties[colName]; });
                saveData(); openTable(currentTableGroup, null, currentTableSubId); closeModal();
            });
        }
        function deleteTableRow(lid) {
             showModal("ลบแถว", "ยืนยัน?", true, () => {
                const layer = layerStore[lid]; map.removeLayer(layer);
                const row = document.getElementById('row-' + lid); if(row) row.remove();
                delete layerStore[lid]; saveData(); openTable(currentTableGroup, null, currentTableSubId); closeModal();
            });
        }
        function addTableRow() {
            const center = map.getCenter();
            const newMarker = createCustomMarker(center, '#1a73e8'); newMarker.addTo(map);
            const props = { name: "จุดใหม่", description: "", _layerName: currentTableGroup };
            const lid = L.stamp(newMarker); layerStore[lid] = newMarker;
            newMarker.feature = { type: "Feature", properties: props };
            const div = document.createElement('div'); div.className = 'layer-item'; div.id = 'row-' + lid;
            div.innerHTML = `<input type="checkbox" checked onchange="toggleLayer(${lid}, this.checked)"><span id="lbl-${lid}">${getIcon(newMarker)} จุดใหม่</span>`;
            div.onclick = (e) => { if(e.target.type!=='checkbox'){ panTo(newMarker); showInfo(newMarker.feature.properties, getCenter(newMarker)); newMarker.openPopup(); }};
            document.getElementById(currentTableSubId).appendChild(div);
            saveData(); openTable(currentTableGroup, null, currentTableSubId);
        }
        function saveTableChanges() { saveData(); document.getElementById('table-modal').style.display = 'none'; }

        // --- Utils ---
        function showModal(t,d,isD,cb) { 
            document.getElementById('modal-title').innerText=t; document.getElementById('modal-desc').innerText=d; 
            document.getElementById('custom-modal').style.display='flex'; 
            document.getElementById('modal-confirm-btn').onclick=()=>{ cb(); closeModal(); }; 
            document.getElementById('modal-input').style.display='none'; 
        }
        function showInputModal(t,l,cb) { 
            document.getElementById('modal-title').innerText=t; document.getElementById('modal-desc').innerText=l; 
            document.getElementById('modal-input').value = ''; document.getElementById('modal-input').style.display='block'; 
            document.getElementById('custom-modal').style.display='flex'; 
            document.getElementById('modal-confirm-btn').onclick=()=>{cb(document.getElementById('modal-input').value);closeModal()}; 
        }
        function closeModal() { document.getElementById('custom-modal').style.display='none'; }
        function showLoader(s) { document.getElementById('loader').style.display = s?'flex':'none'; }
        function askDeleteGroup(id, menuId) { 
            if(menuId) document.getElementById(menuId).style.display='none'; 
            showModal("ลบเลเยอร์", "ยืนยัน?", true, ()=>{ 
                const groupTitle = document.getElementById(id).querySelector('.group-title').innerText;
                document.getElementById(id).remove(); 
                Object.values(layerStore).forEach(l=>{
                    if(l.feature.properties._layerName === groupTitle) { map.removeLayer(l); delete layerStore[L.stamp(l)]; }
                });
                saveData(); closeModal();
            }); 
        }
        window.toggleSize = () => document.getElementById('sidebar-right').classList.toggle('expanded');
        function getSmartName(p) { for(let k in p) if(/name|title|ชื่อ/i.test(k)) return p[k]; return Object.values(p)[0] || "วัตถุ"; }
        function getIcon(l) { return (l instanceof L.Marker)?'<i class="fa-solid fa-location-dot" style="color:#1a73e8"></i>':'<i class="fa-solid fa-route" style="color:#1a73e8"></i>'; }
        function panTo(l) { l.getBounds ? map.fitBounds(l.getBounds()) : (map.panTo(l.getLatLng()), map.setZoom(17)); }
        function getCenter(l) { return l.getLatLng ? l.getLatLng() : l.getBounds().getCenter(); }
        function showInfo(props, latlng) { map.panTo(latlng); let h = ""; for(let k in props) if(!k.startsWith('_')) h += `<div class="info-row"><div class="label">${k}</div><div class="value">${props[k]}</div></div>`; h += `<div class="info-row"><div class="label">พิกัด</div><div class="value">${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</div></div>`; document.getElementById('info-container').innerHTML = h; updateSV(latlng); }
        function updateSV(latlng) { document.getElementById('sv-msg').style.display='none'; document.getElementById('sv-image').style.display='none'; document.getElementById('sv-iframe').src=`https://maps.google.com/maps?q=&layer=c&cbll=${latlng.lat},${latlng.lng}&cbp=11,0,0,0,0&output=svembed`; document.getElementById('sv-iframe').style.display='block'; }
        window.onload = initDashboard;

        // --- SUPABASE SAVE LOGIC (Modern) ---
        const MY_PROJECT_URL = 'https://ajegnkjhsggcsewoczim.supabase.co'; 
        const MY_API_KEY = 'sb_publishable_yyBuBlGayLz7OD4L2WSDRQ_-dusWneS';
        const dbClient = supabase.createClient(MY_PROJECT_URL, MY_API_KEY);

        function saveProject() {
            const modal = document.getElementById('saveModal');
            const box = document.getElementById('saveModalBox');
            modal.style.display = 'flex';
            document.getElementById('saveIconContainer').innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i>';
            document.getElementById('saveIconContainer').style.color = '#1a73e8';
            document.getElementById('saveTitle').innerText = 'บันทึกโปรเจกต์';
            document.getElementById('saveActions').style.display = 'flex';
            document.getElementById('projectNameInput').style.display = 'block';
            document.getElementById('btnConfirmSave').innerText = 'บันทึกทันที';
            document.getElementById('btnConfirmSave').disabled = false;
            setTimeout(() => { box.classList.add('active'); }, 10);
            document.getElementById('projectNameInput').focus();
        }

        function closeSaveModal() {
            const box = document.getElementById('saveModalBox');
            box.classList.remove('active');
            setTimeout(() => { document.getElementById('saveModal').style.display = 'none'; }, 200);
        }

        async function confirmSaveToSupabase() {
            const nameInput = document.getElementById('projectNameInput');
            const projectName = nameInput.value;
            if (!projectName) { alert("กรุณาตั้งชื่อก่อนครับ"); return; }

            const btn = document.getElementById('btnConfirmSave');
            btn.innerText = "กำลังส่งข้อมูล..."; btn.disabled = true;

            const mapState = { lat: map.getCenter().lat, lng: map.getCenter().lng, zoom: map.getZoom() };
            const layers = [];
            if (typeof layerStore !== 'undefined') {
                for (let id in layerStore) {
                    const layer = layerStore[id];
                    const gid = layer.subId || 'Uncategorized';
                    let title = "Group " + gid;
                    try {
                         const el = document.getElementById(gid);
                         if(el && el.previousElementSibling) title = el.previousElementSibling.querySelector('.group-title').innerText;
                    } catch(e){}
                    layers.push({ id: gid, name: title, features: layerStore[id].toGeoJSON() });
                }
            }

            try {
                const { data, error } = await dbClient 
                    .from('projects')
                    .insert([{ name: projectName, map_state: mapState, layers: layers }]);

                if (error) throw error;

                document.getElementById('saveIconContainer').innerHTML = '<i class="fa-solid fa-circle-check"></i>';
                document.getElementById('saveIconContainer').style.color = '#28a745';
                document.getElementById('saveTitle').innerText = 'บันทึกเรียบร้อย!';
                document.getElementById('projectNameInput').style.display = 'none';
                document.getElementById('saveActions').style.display = 'none';

                setTimeout(() => { closeSaveModal(); nameInput.value = ''; }, 1500);

            } catch (err) {
                console.error(err); alert("❌ บันทึกไม่ได้: " + err.message);
                btn.innerText = "ลองใหม่"; btn.disabled = false;
            }
        }
    </script>
</body>
</html>